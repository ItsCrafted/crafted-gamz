<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <link rel="icon" href="favicon.png">
  <title>Crafted Gamz | Main Page</title>
<script src="random-messages.js"></script>

<script>
  window.addEventListener('DOMContentLoaded', () => {
    const introFlag = localStorage.getItem('intro');
    if (introFlag === '1') {
      const audio = document.getElementById('intro-audio');
      if (audio) {
        // Reset first so it won't happen on refresh
        localStorage.setItem('intro', '0');

        // Try to play the audio
        audio.play().catch(e => { 
          console.warn('Autoplay failed:', e);
        });
      }
    }
  });
</script>
<link rel="manifest" href="/manifest.json" />
 <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>

  @font-face {
  font-family: 'Crafted';
  src: url('crafted-font.ttf') format('truetype');
  font-display: swap;
}

    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: sans-serif;
      overflow-x: hidden;
    }

    iframe {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      z-index: -1;
      border: none;
    }

    .container {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 40px;
      padding: 60px;
      padding-top: 20vh;
      box-sizing: border-box;
    }

    .box {
      height: 250px;
      border-radius: 12px;
      opacity: 0.85;
      transition: transform 0.2s ease, background-color 0.3s ease;
      padding: 20px;
      color: white;
      display: flex;
      flex-direction: column;
      justify-content: center;
      text-align: center;
      overflow: hidden;
    }

    .box:hover {
      transform: scale(1.05);
      background-color: #081a2e;
    }

    .version-text {
      text-align: center;
      font-size: 3em;
      font-weight: bold;
      color: white;
      margin-top: 20vh;
     line-height: 1; 
    }

.version-text h1 span {
  background: linear-gradient(135deg, #007bff, #00d4ff);
  -webkit-background-clip: text;
  color: transparent;
  font-size: 150px;
  font-weight: bold;
  transition: transform 0.3s, background 0.3s, box-shadow 0.3s;
  font-family: 'Crafted', sans-serif;
}


    .social-icons {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-top: 10px;
    }

    .icon {
      width: 40px;
      height: 40px;
      object-fit: contain;
      border-radius: 8px;
      transition: transform 0.2s ease;
    }

    .icon:hover {
      transform: scale(1.2);
    }

    .box img {
      max-width: 100%;
      height: auto;
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .box4 img, .box5 img {
      display: none;
    }

    .box6 img {
      display: block;
    }

    .box1 { background-color: rgba(0, 0, 0, 0.8); }
    .box2 { background-color: rgba(0, 0, 0, 0.8); }
    .box3 { background-color: rgba(0, 0, 0, 0.8); }
    .box4 { background-color: rgba(0, 0, 0, 0.8); }
    .box5 { background-color: rgba(0, 0, 0, 0.8); }
    .box6 { background-color: rgba(0, 0, 0, 0.8); }

    @media (max-width: 768px) {
      .container {
        grid-template-columns: 1fr;
      }
    }

  /* For Firefox */
* {
  scrollbar-width: thin;
  scrollbar-color: #00ffe5 transparent;
}

/* For Chrome, Edge, Safari */
*::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

*::-webkit-scrollbar-track {
  background: transparent;
}

*::-webkit-scrollbar-thumb {
  background-color: #00ffe5;
  border-radius: 10px;
  border: 2px solid transparent; /* Optional: adds some padding effect */
}

#random-message {
  cursor: pointer;
}

#random-message:hover {
  color: #4bf9ed;
  transform: scale(1.05);
}

  .icon {
    font-size: 40px;
    color: #96f3f5;
    margin: 0 12px;
    transition: color 0.3s ease;
  }
  .icon:hover {
    color: #4bf9ed; /* a brighter blue on hover */
  }
  </style>
</head>
<body>
<audio id="intro-audio" src="intro_p2.mp3" preload="auto"></audio>

  <iframe src="bg.html"></iframe>

<script src="periodSchedule.js"></script>
<script src="nav.js" defer></script>


<div class="version-text"> 
  <h1><span>Crafted Gamz</span><br><span class="version">Version 12</span><br><span class="version">BETA</span></h1>
  <p id="random-message" style="font-size: 30px; color: #ccc;"></p>
</div>

<div id="visitors"></div>

  <div class="container">
<div class="box box1">
  <h2>Most Popular (Live)</h2>
  <div id="leaderboard">
    Loading leaderboard...
  </div>
</div>
<div class="box box2">
    <h2>Newest Feature</h2>
    <h2>Current Version:</h2>
    <div id="version"></div>
<script src="version.js"></script>
<script>
  document.getElementById('version').innerText = version;
</script>

  <p id="latest-feature">Loading latest update...</p>
</div>
<div class="box box3">
<h2>CGPUP Status</h2>
<div id="uptime-status" style="margin-top: 10px; font-size: 1.2rem; color: #96f3f5;">
  Checking status...
</div>

</div>
    <div class="box box4">
  <h2>Choice Of The Month</h2>
  <h3>This Month's Pick:</h3>
  <div id="value" style="font-size: 2.5rem; font-weight: 700; margin-top: 0.5rem;">Loading...</div>
    </div>
    <div class="box box5">
      <h2>Do it Yourself</h2>
<a href="diy.html" style="
  background-color: #4bf9ed;
  color: #1a1a1a;
  padding: 0.5rem 1rem;
  border-radius: 6px;
  text-decoration: none;
  font-weight: bold;
  display: inline-block;
  max-width: 400px;
  align-self: center;
">How to deploy Crafted Gamz for yourself</a>

    </div>
    <div class="box box6">
      <h2>Social & Contact</h2>
      <div class="social-icons">
<a href="https://discordid.netlify.app/?id=1216168493213552660" target="_blank" aria-label="Discord">
  <i class="fab fa-discord icon"></i>
</a>
<a href="mailto:crafted@craftedgamz.com" target="_blank" aria-label="Email">
  <i class="fas fa-envelope icon"></i>
</a>
<a href="https://github.com/ItsCrafted" target="_blank" aria-label="GitHub">
  <i class="fab fa-github icon"></i>
</a>
<a href="https://youtube.com/@its_crafted" target="_blank" aria-label="YouTube">
  <i class="fab fa-youtube icon"></i>
</a>
        </a>
      </div>
    </div>
  </div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<script>
// Global variables
let firebaseApp;
let db;

// Load Firebase config from Netlify function
async function loadFirebaseConfig() {
  try {
    const res = await fetch('/.netlify/functions/get-firebase-config');
    if (!res.ok) throw new Error('Failed to fetch Firebase config');
    const config = await res.json();
    return config;
  } catch (error) {
    console.error('Error loading Firebase config:', error);
    throw error;
  }
}

// Initialize Firebase and run all Firebase-dependent functions
async function initializeFirebase() {
  try {
    const config = await loadFirebaseConfig();
    
    // Initialize Firebase
    firebaseApp = firebase.initializeApp(config);
    db = firebase.firestore();
    
    console.log('Firebase initialized successfully');
    
    // Now run all Firebase-dependent functions
    await Promise.all([
      trackVisit(),
      loadLeaderboard()
    ]);
    
    // Set up leaderboard auto-refresh
    setInterval(loadLeaderboard, 1000);
    
  } catch (error) {
    console.error('Failed to initialize Firebase:', error);
    // Update UI to show error state
    document.getElementById('leaderboard').textContent = 'Failed to connect to database.';
    document.getElementById('visitors').innerHTML = '<div style="color: red; text-align: center;">Failed to load visitor stats</div>';
  }
}

// Get today's date key (YYYY-MM-DD format)
function getTodayKey() {
  const today = new Date();
  return today.toISOString().split('T')[0];
}

// Get current month key (YYYY-MM format)
function getMonthKey() {
  const today = new Date();
  const year = today.getFullYear();
  const month = String(today.getMonth() + 1).padStart(2, '0');
  return `${year}-${month}`;
}

// Track visitor using counters - FIXED VERSION
async function trackVisit() {
  try {
    const todayKey = getTodayKey();
    const monthKey = getMonthKey();
    
    // References to counter documents
    const allTimeRef = db.collection('stats').doc('allTime');
    const todayRef = db.collection('stats').doc(todayKey);
    const monthRef = db.collection('stats').doc(monthKey);
    
    // Use set with merge: true and increment to handle non-existent documents
    const batch = db.batch();
    
    batch.set(allTimeRef, {
      count: firebase.firestore.FieldValue.increment(1)
    }, { merge: true });
    
    batch.set(todayRef, {
      count: firebase.firestore.FieldValue.increment(1),
      date: todayKey
    }, { merge: true });
    
    batch.set(monthRef, {
      count: firebase.firestore.FieldValue.increment(1),
      month: monthKey
    }, { merge: true });
    
    // Execute batch write
    await batch.commit();
    console.log('Visit tracked successfully');
    
    // Now read the updated stats
    await loadVisitorStats();
    
  } catch (error) {
    console.error('Error tracking visit:', error);
    // Fallback: try to load existing stats even if tracking failed
    await loadVisitorStats();
  }
}

// Load visitor statistics from counter documents
async function loadVisitorStats() {
  try {
    const todayKey = getTodayKey();
    const monthKey = getMonthKey();
    
    // Get all stats in parallel
    const [allTimeDoc, todayDoc, monthDoc] = await Promise.all([
      db.collection('stats').doc('allTime').get(),
      db.collection('stats').doc(todayKey).get(),
      db.collection('stats').doc(monthKey).get()
    ]);
    
    const allTime = allTimeDoc.exists ? allTimeDoc.data().count : 0;
    const today = todayDoc.exists ? todayDoc.data().count : 0;
    const month = monthDoc.exists ? monthDoc.data().count : 0;
    
    console.log('Visitor stats loaded:', { allTime, today, month });
    
    // Update visitor stats in UI
    const container = document.createElement('div');
    container.style.cssText = `
      background: rgba(0, 0, 0, 0.8);
      color: #4bf9ed;
      padding: 16px 24px;
      border-radius: 12px;
      font-size: 16px;
      font-family: sans-serif;
      text-align: center;
      margin: 0 auto;
      width: fit-content;
    `;
    
    container.innerHTML = `
      <b>Crafted Gamz Visitors</b><br>
      Today: ${today}<br>
      This Month: ${month}<br>
      All-time: ${allTime}<br>
    `;
    
    // Clear previous stats and add new ones
    const visitorsDiv = document.getElementById('visitors');
    visitorsDiv.innerHTML = '';
    visitorsDiv.appendChild(container);
    
    console.log('Visitor stats UI updated');
    
  } catch (error) {
    console.error('Error loading visitor stats:', error);
    // Show error state in UI
    const visitorsDiv = document.getElementById('visitors');
    visitorsDiv.innerHTML = '<div style="color: red; text-align: center;">Failed to load visitor stats</div>';
  }
}

// Load leaderboard
function loadLeaderboard() {
  if (!db) return;
  
  db.collection('gameCounts')
    .orderBy('count', 'desc')
    .limit(3)
    .get()
    .then(snapshot => {
      const leaderboard = document.getElementById('leaderboard');
      if (snapshot.empty) {
        leaderboard.textContent = 'No data yet.';
        return;
      }
      leaderboard.innerHTML = '';
      let rank = 1;
      snapshot.forEach(doc => {
        const data = doc.data();
        const div = document.createElement('div');
        div.style.marginBottom = '10px';
        div.innerHTML = `<strong>#${rank}: ${doc.id}</strong> â€” ${data.count} plays`;
        leaderboard.appendChild(div);
        rank++;
      });
    })
    .catch(error => {
      document.getElementById('leaderboard').textContent = 'Failed to load leaderboard.';
      console.error('Error fetching leaderboard:', error);
    });
}

// Initialize everything when page loads
document.addEventListener('DOMContentLoaded', () => {
  initializeFirebase();
});
</script>

<script>
  // Load monthly choice value
  async function fetchValue() {
    try {
      const res = await fetch('/value.json');
      if (!res.ok) throw new Error('Network error');
      const data = await res.json();
      document.getElementById('value').textContent = data.value;
    } catch (e) {
      document.getElementById('value').textContent = 'Error loading value';
      console.error(e);
    }
  }
  fetchValue();
</script>

<script>
  // Load latest GitHub commit
  fetch("https://api.github.com/repos/ItsCrafted/crafted-gamz/commits")
    .then(response => response.json())
    .then(commits => {
      const latest = commits[0];
      const message = latest.commit.message;
      const rawAuthor = latest.commit.author.name;
      const author = rawAuthor.split(" ").map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(" ");
      const dateTime = new Date(latest.commit.author.date).toLocaleString();

      document.getElementById("latest-feature").innerHTML = 
        `The latest commit is: "<span style="color:#4bf9ed;">${message}</span>" by <span style="color:#4bf9ed;">${author}</span> on <span style="color:#4bf9ed;">${dateTime}</span>`;
    })
    .catch(error => {
      document.getElementById("latest-feature").innerText = "Could not load latest commit.";
      console.error(error);
    });
</script>
<script>
  const statusEl = document.getElementById('uptime-status');

  function updateStatus() {
    fetch('https://api.uptimerobot.com/v2/getMonitors', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams({
        api_key: 'm800913241-525531581fb67985a2b338b2',
        format: 'json'
      })
    })
    .then(res => res.json())
    .then(data => {
      if (!data.monitors || data.monitors.length === 0) {
        statusEl.innerHTML = 'No monitors found.';
        return;
      }

      const monitor = data.monitors[0];
      const status = monitor.status;

      const statusMap = {
        0: '<span style="color: gray;"><i class="fa fa-pause-circle"></i> Paused</span>',
        1: '<span style="color: gray;"><i class="fa fa-clock"></i> Not Checked Yet</span>',
        2: '<span style="color: #00ff99;"><i class="fa fa-circle-check"></i> Up</span>',
        8: '<span style="color: #ffc107;"><i class="fa fa-exclamation-triangle"></i> Seems Down</span>',
        9: '<span style="color: #ff4d4d;"><i class="fa fa-circle-xmark"></i> Down</span>'
      };

      statusEl.innerHTML = `
        <div>Status: ${statusMap[status]}</div>
        <div style="margin-top: 8px; color: #ccc;">Checks every 5 minutes</div>
      `;
    })
    .catch(err => {
      statusEl.innerHTML = '<span style="color: red;">Error loading status</span>';
      console.error('UptimeRobot error:', err);
    });
  }

  updateStatus();
  setInterval(updateStatus, 50000);
</script>

</body>
</html>